"""
Complete Retell WebSocket Handler
Includes:
- Multilingual support (Hindi, Punjabi, English)
- Multi-intent detection (6 tools)
- Area hotspot tracking
- Language detection and persistence
- All complaint handling features
"""
import json
import uuid
from datetime import datetime
from fastapi import APIRouter, WebSocket, WebSocketDisconnect
from sqlalchemy import text
from app.services.rag import RAGService
from app.services.llm import get_ai_response, detect_language
from app.services.area_hotspot import update_area_hotspot
from app.db import engine
from app.ws import manager

router = APIRouter()
rag_service = RAGService()

# Store conversation history and language per call
CONVERSATION_HISTORY = {}
DETECTED_LANGUAGE = {}

# Confirmation keywords (multilingual)
CONFIRM_WORDS = [
    # English
    "yes", "yeah", "yep", "please", "go ahead", "confirm", "sure", "okay", "ok", "proceed",
    # Hindi
    "haan", "ha", "bilkul", "theek hai", "karo", "zaroor",
    # Punjabi
    "haan", "theek", "karo"
]


def extract_latest_user_message(transcript: list) -> str:
    """Extract the most recent user message from Retell transcript."""
    for item in reversed(transcript):
        if item.get("role") == "user":
            return item.get("content", "").strip()
    return ""


def detect_confirmation(text: str) -> bool:
    """Check if user is confirming (multilingual)."""
    text_lower = text.lower()
    return any(word in text_lower for word in CONFIRM_WORDS)


def get_multilingual_greeting(language: str = "english") -> str:
    """Get greeting in detected language."""
    greetings = {
        "hindi": "Namaste, main Vani hoon Delhi Sarkar ki AI Voice Assistant. Main aapki kaise madad kar sakti hoon?",
        "punjabi": "Sat Sri Akal, main Vani haan Delhi Sarkar di AI Voice Assistant. Main tussi ki madad kar sakdi haan?",
        "english": "Hello, I am Vani, the AI Voice Assistant for Delhi Government. How can I help you today?"
    }
    return greetings.get(language, greetings["english"])


@router.websocket("/llm-websocket/call_{call_id}")
async def retell_llm_ws(websocket: WebSocket, call_id: str):
    """
    Main WebSocket handler for Retell AI integration.
    Handles all types of citizen interactions with multilingual support.
    """
    await websocket.accept()
    print(f"‚úÖ Retell connected | call_id={call_id}")

    # Initialize conversation history and language
    CONVERSATION_HISTORY[call_id] = []
    DETECTED_LANGUAGE[call_id] = "english"  # Default until detected

    try:
        # Send initial greeting (in English, will adapt after first message)
        greeting = "Namaste, I am Vani from the Delhi Government. How can I help you today?"
        
        await websocket.send_json({
            "response_id": 0,
            "content": greeting,
            "content_complete": True,
            "end_call": False
        })
        
        CONVERSATION_HISTORY[call_id].append({
            "role": "assistant",
            "content": greeting
        })

        while True:
            data = await websocket.receive_json()

            # ===================================================================
            # HANDLE HEARTBEAT (Retell ping-pong)
            # ===================================================================
            if data.get("interaction_type") == "ping_pong":
                await websocket.send_json({
                    "interaction_type": "ping_pong",
                    "timestamp": data.get("timestamp")
                })
                continue

            # ===================================================================
            # HANDLE USER SPEECH
            # ===================================================================
            if data.get("interaction_type") == "response_required":
                response_id = data["response_id"]
                transcript = data.get("transcript", [])

                user_text = extract_latest_user_message(transcript)
                
                if not user_text:
                    continue

                print(f"\nüó£Ô∏è USER SAID: {user_text}")

                # Detect language from first user message
                if len(CONVERSATION_HISTORY[call_id]) <= 1:
                    detected_lang = detect_language(user_text)
                    DETECTED_LANGUAGE[call_id] = detected_lang
                    print(f"üåç Language detected: {detected_lang}")

                # Add to history
                CONVERSATION_HISTORY[call_id].append({
                    "role": "user",
                    "content": user_text
                })

                # Get RAG context
                context = await rag_service.get_context(user_text)
                
                # Detect confirmation
                user_confirmed = detect_confirmation(user_text)

                # Get AI response with multi-intent detection and language support
                ai_response = await get_ai_response(
                    messages=CONVERSATION_HISTORY[call_id],
                    context=context,
                    user_confirmed=user_confirmed,
                    language=DETECTED_LANGUAGE[call_id]
                )

                spoken_text = ai_response.get("content", "").strip()
                tool_calls = ai_response.get("tool_calls", [])
                response_language = ai_response.get("detected_language", DETECTED_LANGUAGE[call_id])

                # Update language if changed
                DETECTED_LANGUAGE[call_id] = response_language

                # ===================================================================
                # HANDLE TOOL CALLS
                # ===================================================================

                for tool in tool_calls:
                    tool_name = tool["name"]
                    
                    try:
                        args = json.loads(tool["arguments"])
                        
                        # ---------------------------------------------------------------
                        # TOOL 1: REGISTER GRIEVANCE
                        # ---------------------------------------------------------------
                        if tool_name == "register_grievance":
                            ticket_id = f"DEL-{uuid.uuid4().hex[:6].upper()}"

                            print(f"\nüìù REGISTERING GRIEVANCE:")
                            print(f"   Ticket ID: {ticket_id}")
                            print(f"   Name: {args.get('name')}")
                            print(f"   Contact: {args.get('contact')}")
                            print(f"   Issue: {args.get('issue')}")
                            print(f"   Location: {args.get('location')}")
                            print(f"   Category: {args.get('category')}")
                            print(f"   Priority: {args.get('priority')}")
                            print(f"   Department: {args.get('department')}")
                            print(f"   Language: {response_language}")

                            with engine.begin() as conn:
                                # Insert complaint
                                conn.execute(
                                    text("""
                                        INSERT INTO grievances 
                                        (ticket_id, citizen_name, contact, description, location, area,
                                         department, category, priority, status, call_id, language)
                                        VALUES (:ticket_id, :name, :contact, :issue, :location, :area,
                                                :dept, :category, :priority, :status, :call_id, :language)
                                    """),
                                    {
                                        "ticket_id": ticket_id,
                                        "name": args.get("name", "Unknown"),
                                        "contact": args.get("contact", ""),
                                        "issue": args.get("issue", ""),
                                        "location": args.get("location", ""),
                                        "area": args.get("location", ""),  # Use location as area
                                        "dept": args.get("department", "General/PGC"),
                                        "category": args.get("category", "Other"),
                                        "priority": args.get("priority", "Medium"),
                                        "status": "OPEN",
                                        "call_id": call_id,
                                        "language": response_language
                                    }
                                )

                            # Update area hotspot tracking
                            try:
                                update_area_hotspot(
                                    area=args.get("location", ""),
                                    category=args.get("category", "Other"),
                                    priority=args.get("priority", "Medium")
                                )
                                print(f"   ‚úÖ Area hotspot updated")
                            except Exception as e:
                                print(f"   ‚ö†Ô∏è Area hotspot update failed: {e}")

                            # Broadcast to dashboard
                            await manager.broadcast({
                                "event": "NEW_GRIEVANCE",
                                "data": {
                                    "ticket_id": ticket_id,
                                    "citizen_name": args.get("name"),
                                    "contact": args.get("contact"),
                                    "issue": args.get("issue"),
                                    "location": args.get("location"),
                                    "category": args.get("category"),
                                    "priority": args.get("priority"),
                                    "department": args.get("department"),
                                    "language": response_language,
                                    "call_id": call_id
                                }
                            })

                            # Generate response in user's language
                            if response_language == "hindi":
                                spoken_text = (
                                    f"Dhanyavaad. Aapki complaint successfully register ho gayi hai. "
                                    f"Aapka ticket number hai {ticket_id}. "
                                    f"Yeh {args.get('priority', 'Medium')} priority complaint hai. "
                                    f"Aapko {args.get('contact')} par SMS updates milenge. "
                                    f"Kya main aur kuch madad kar sakti hoon?"
                                )
                            elif response_language == "punjabi":
                                spoken_text = (
                                    f"Shukriya. Tuhadi complaint successfully register ho gayi hai. "
                                    f"Tuhada ticket number hai {ticket_id}. "
                                    f"Eh {args.get('priority', 'Medium')} priority complaint hai. "
                                    f"Tuhanu {args.get('contact')} te SMS updates milange. "
                                    f"Ki main hor kuch madad kar sakdi haan?"
                                )
                            else:
                                spoken_text = (
                                    f"Your complaint has been registered successfully. "
                                    f"Your ticket number is {ticket_id}. "
                                    f"This has been marked as {args.get('priority', 'Medium')} priority. "
                                    f"You will receive SMS updates on {args.get('contact')}. "
                                    f"Is there anything else I can help you with?"
                                )
                            
                            print(f"‚úÖ Complaint registered: {ticket_id}")

                        # ---------------------------------------------------------------
                        # TOOL 2: CHECK STATUS
                        # ---------------------------------------------------------------
                        elif tool_name == "check_complaint_status":
                            ticket_id = args.get("ticket_id", "").upper()
                            
                            print(f"\nüîç CHECKING STATUS: {ticket_id}")

                            with engine.begin() as conn:
                                # Log the status check
                                conn.execute(
                                    text("""
                                        INSERT INTO status_checks 
                                        (ticket_id, phone_number, call_id)
                                        VALUES (:ticket_id, :phone, :call_id)
                                    """),
                                    {
                                        "ticket_id": ticket_id,
                                        "phone": args.get("phone_number", ""),
                                        "call_id": call_id
                                    }
                                )
                                
                                # Fetch complaint details
                                result = conn.execute(
                                    text("""
                                        SELECT ticket_id, status, description, department, 
                                               category, priority, created_at, resolved_at
                                        FROM grievances 
                                        WHERE ticket_id = :ticket_id
                                    """),
                                    {"ticket_id": ticket_id}
                                )
                                
                                complaint = result.fetchone()

                            if complaint:
                                status = complaint[1]
                                dept = complaint[3]
                                priority = complaint[5]
                                
                                # Multilingual status responses
                                if response_language == "hindi":
                                    status_messages = {
                                        "OPEN": "currently open hai aur review ho rahi hai",
                                        "IN_PROGRESS": "in progress hai aur handle ho rahi hai",
                                        "RESOLVED": "resolve ho gayi hai",
                                        "CLOSED": "close ho gayi hai",
                                        "ESCALATED": "escalate kar di gayi hai higher authorities ko"
                                    }
                                    spoken_text = (
                                        f"Aapki complaint ticket number {ticket_id} "
                                        f"{status_messages.get(status, 'process ho rahi hai')} "
                                        f"{dept} dwara. "
                                        f"Yeh ek {priority} priority issue hai. "
                                        f"Kya aur kuch janna chahte hain?"
                                    )
                                elif response_language == "punjabi":
                                    status_messages = {
                                        "OPEN": "open hai te review ho rahi hai",
                                        "IN_PROGRESS": "progress vich hai",
                                        "RESOLVED": "resolve ho gayi hai",
                                        "CLOSED": "close ho gayi hai",
                                        "ESCALATED": "escalate ho gayi hai"
                                    }
                                    spoken_text = (
                                        f"Tuhadi complaint ticket number {ticket_id} "
                                        f"{status_messages.get(status, 'process ho rahi hai')} "
                                        f"{dept} valon. "
                                        f"Eh ek {priority} priority issue hai. "
                                        f"Ki hor kuch janna chahunde ho?"
                                    )
                                else:
                                    status_messages = {
                                        "OPEN": "is currently open and being reviewed by",
                                        "IN_PROGRESS": "is in progress and being handled by",
                                        "RESOLVED": "has been resolved by",
                                        "CLOSED": "has been closed by",
                                        "ESCALATED": "has been escalated to higher authorities in"
                                    }
                                    spoken_text = (
                                        f"Your complaint with ticket number {ticket_id} "
                                        f"{status_messages.get(status, 'is being processed by')} "
                                        f"{dept}. "
                                        f"This is a {priority} priority issue. "
                                        f"Is there anything else I can help you with?"
                                    )
                            else:
                                if response_language == "hindi":
                                    spoken_text = (
                                        f"Maaf kijiye, mujhe {ticket_id} ticket number ki koi complaint nahi mili. "
                                        f"Kripya ticket number check karein aur phir se try karein."
                                    )
                                elif response_language == "punjabi":
                                    spoken_text = (
                                        f"Maaf karna, mujhe {ticket_id} ticket number di koi complaint nahi mili. "
                                        f"Meharbani karke ticket number check karo."
                                    )
                                else:
                                    spoken_text = (
                                        f"I could not find a complaint with ticket number {ticket_id}. "
                                        f"Please check the ticket number and try again."
                                    )
                            
                            print(f"‚úÖ Status checked: {ticket_id}")

                        # ---------------------------------------------------------------
                        # TOOL 3: ESCALATE COMPLAINT
                        # ---------------------------------------------------------------
                        elif tool_name == "escalate_complaint":
                            ticket_id = args.get("ticket_id", "").upper()
                            reason = args.get("reason", "")
                            
                            print(f"\n‚¨ÜÔ∏è ESCALATING: {ticket_id}")

                            with engine.begin() as conn:
                                # Log escalation
                                conn.execute(
                                    text("""
                                        INSERT INTO escalations 
                                        (ticket_id, reason, escalated_by, call_id)
                                        VALUES (:ticket_id, :reason, :phone, :call_id)
                                    """),
                                    {
                                        "ticket_id": ticket_id,
                                        "reason": reason,
                                        "phone": args.get("phone_number", ""),
                                        "call_id": call_id
                                    }
                                )
                                
                                # Update complaint status
                                conn.execute(
                                    text("""
                                        UPDATE grievances 
                                        SET status = 'ESCALATED',
                                            escalated = escalated + 1,
                                            escalation_reason = :reason,
                                            updated_at = NOW()
                                        WHERE ticket_id = :ticket_id
                                    """),
                                    {"ticket_id": ticket_id, "reason": reason}
                                )

                            # Multilingual escalation response
                            if response_language == "hindi":
                                spoken_text = (
                                    f"Aapki complaint {ticket_id} ko senior authorities ke paas escalate kar diya gaya hai. "
                                    f"Aapko 24 ghante mein ek senior officer ka call aayega. "
                                    f"Kya main aur kuch madad kar sakti hoon?"
                                )
                            elif response_language == "punjabi":
                                spoken_text = (
                                    f"Tuhadi complaint {ticket_id} nu senior authorities kol escalate kar dita gaya hai. "
                                    f"Tuhanu 24 ghante vich senior officer da call aavega. "
                                    f"Ki main hor kuch madad kar sakdi haan?"
                                )
                            else:
                                spoken_text = (
                                    f"Your complaint {ticket_id} has been escalated to senior authorities. "
                                    f"You will receive a call from a senior officer within 24 hours. "
                                    f"Is there anything else I can help you with?"
                                )
                            
                            print(f"‚úÖ Escalated: {ticket_id}")

                        # ---------------------------------------------------------------
                        # TOOL 4: GENERAL INFO
                        # ---------------------------------------------------------------
                        elif tool_name == "provide_general_info":
                            query_type = args.get("query_type", "")
                            
                            print(f"\nüìñ PROVIDING INFO: {query_type}")
                            
                            # Spoken text should already be generated by LLM based on RAG context
                            if not spoken_text:
                                if response_language == "hindi":
                                    spoken_text = (
                                        "Available information ke anusar, main aapki madad kar sakti hoon. "
                                        "Kya aap kuch specific janna chahte hain?"
                                    )
                                elif response_language == "punjabi":
                                    spoken_text = (
                                        "Available information anusar, main tuhadi madad kar sakdi haan. "
                                        "Ki tussi kuch specific janna chahunde ho?"
                                    )
                                else:
                                    spoken_text = (
                                        "Based on the available information, I can help you with that. "
                                        "Is there anything specific you'd like to know?"
                                    )

                        # ---------------------------------------------------------------
                        # TOOL 5: RECORD FEEDBACK
                        # ---------------------------------------------------------------
                        elif tool_name == "record_feedback":
                            rating = args.get("rating", 3)
                            feedback_text = args.get("feedback_text", "")
                            
                            print(f"\n‚≠ê RECORDING FEEDBACK: {rating}/5")

                            with engine.begin() as conn:
                                conn.execute(
                                    text("""
                                        INSERT INTO feedback 
                                        (ticket_id, rating, feedback_text, phone_number, call_id)
                                        VALUES (:ticket_id, :rating, :feedback, :phone, :call_id)
                                    """),
                                    {
                                        "ticket_id": args.get("ticket_id", None),
                                        "rating": rating,
                                        "feedback": feedback_text,
                                        "phone": args.get("phone_number", ""),
                                        "call_id": call_id
                                    }
                                )

                            # Multilingual feedback acknowledgment
                            if response_language == "hindi":
                                spoken_text = (
                                    f"Aapke feedback ke liye dhanyavaad. "
                                    f"Aapki {rating}-star rating record ho gayi hai. "
                                    f"Hum aapke feedback ki kadar karte hain."
                                )
                            elif response_language == "punjabi":
                                spoken_text = (
                                    f"Tuhade feedback vaste shukriya. "
                                    f"Tuhadi {rating}-star rating record ho gayi hai. "
                                    f"Assi tuhade feedback di kadar karde haan."
                                )
                            else:
                                spoken_text = (
                                    f"Thank you for your feedback. "
                                    f"Your {rating}-star rating has been recorded. "
                                    f"We appreciate your input in helping us improve our services."
                                )
                            
                            print(f"‚úÖ Feedback recorded: {rating}/5")

                        # ---------------------------------------------------------------
                        # TOOL 6: EMERGENCY
                        # ---------------------------------------------------------------
                        elif tool_name == "emergency_assistance":
                            emergency_type = args.get("emergency_type", "")
                            location = args.get("location", "")
                            
                            print(f"\nüö® EMERGENCY: {emergency_type} at {location}")

                            with engine.begin() as conn:
                                conn.execute(
                                    text("""
                                        INSERT INTO emergencies 
                                        (emergency_type, location, phone_number, description, call_id)
                                        VALUES (:type, :location, :phone, :description, :call_id)
                                    """),
                                    {
                                        "type": emergency_type,
                                        "location": location,
                                        "phone": args.get("phone_number", ""),
                                        "description": args.get("description", ""),
                                        "call_id": call_id
                                    }
                                )

                            # Broadcast emergency alert
                            await manager.broadcast({
                                "event": "EMERGENCY_ALERT",
                                "data": {
                                    "type": emergency_type,
                                    "location": location,
                                    "phone": args.get("phone_number"),
                                    "description": args.get("description"),
                                    "call_id": call_id,
                                    "language": response_language
                                }
                            })

                            # Multilingual emergency response
                            if response_language == "hindi":
                                spoken_text = (
                                    f"Maine turant emergency services ko {location} par {emergency_type} ke baare mein notify kar diya hai. "
                                    f"Madad aa rahi hai. Kripya line par rahiye."
                                )
                            elif response_language == "punjabi":
                                spoken_text = (
                                    f"Maine turant emergency services nu {location} te {emergency_type} bare notify kar dita hai. "
                                    f"Madad aa rahi hai. Meharbani karke line te raho."
                                )
                            else:
                                spoken_text = (
                                    f"I have immediately notified emergency services about the {emergency_type} "
                                    f"at {location}. Help is on the way. Please stay on the line."
                                )
                            
                            print(f"üö® Emergency logged and escalated!")

                    except json.JSONDecodeError as e:
                        print(f"‚ùå JSON parsing error: {e}")
                        if response_language == "hindi":
                            spoken_text = "Maaf kijiye, mujhe samajhne mein dikkat hui. Kya aap phir se bol sakte hain?"
                        elif response_language == "punjabi":
                            spoken_text = "Maaf karna, mujhe samajhne vich dikkat aayi. Ki tussi phir bol sakde ho?"
                        else:
                            spoken_text = "I apologize, I had trouble processing that. Could you please repeat?"

                    except Exception as e:
                        print(f"‚ùå Tool execution error: {e}")
                        import traceback
                        traceback.print_exc()
                        
                        if response_language == "hindi":
                            spoken_text = (
                                "Maaf kijiye, mujhe technical dikkat aa rahi hai. "
                                "Kripya phir se try karein ya helpline 1800-XXX-XXXX par call karein."
                            )
                        elif response_language == "punjabi":
                            spoken_text = (
                                "Maaf karna, mujhe technical problem aa rahi hai. "
                                "Meharbani karke phir try karo ya helpline 1800-XXX-XXXX te call karo."
                            )
                        else:
                            spoken_text = (
                                "I apologize, I'm having technical difficulties. "
                                "Please try again or contact our helpline at 1800-XXX-XXXX."
                            )

                # Ensure we have something to say
                if not spoken_text:
                    if response_language == "hindi":
                        spoken_text = "Maaf kijiye, kya aap phir se bol sakte hain?"
                    elif response_language == "punjabi":
                        spoken_text = "Maaf karna, ki tussi phir bol sakde ho?"
                    else:
                        spoken_text = "I'm sorry, could you please repeat that?"

                print(f"ü§ñ ASSISTANT SAID ({response_language}): {spoken_text}")

                # Send response to Retell
                await websocket.send_json({
                    "response_id": response_id,
                    "content": spoken_text,
                    "content_complete": True,
                    "end_call": False
                })

                # Add assistant response to history
                CONVERSATION_HISTORY[call_id].append({
                    "role": "assistant",
                    "content": spoken_text
                })

                # Limit conversation history to prevent token overflow
                if len(CONVERSATION_HISTORY[call_id]) > 20:
                    CONVERSATION_HISTORY[call_id] = CONVERSATION_HISTORY[call_id][-18:]

    except WebSocketDisconnect:
        print(f"‚ùå Retell disconnected | call_id={call_id}")
        
    except Exception as e:
        print(f"üö® ERROR | call_id={call_id} | {e}")
        import traceback
        traceback.print_exc()
        
    finally:
        # Cleanup
        CONVERSATION_HISTORY.pop(call_id, None)
        DETECTED_LANGUAGE.pop(call_id, None)
        print(f"üßπ Cleaned up call state for {call_id}")